---
import { getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import TopLayout from "@layouts/TopLayout.astro";
import BottomLayout from "@layouts/BottomLayout.astro";
import Blog from "@components/Blog";
import Pagination from "@components/Pagination.astro";
import { BLOG } from "@consts";

const POSTS_PER_PAGE = 10;
const allPosts = (await getCollection("blog"))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const tags = [...new Set(allPosts.flatMap((post) => post.data.tags))].sort(
  (a, b) => a.localeCompare(b)
);
const { page = 1 } = Astro.params;
const currentPage = typeof page === "string" ? parseInt(page) : page;
const totalPosts = allPosts.length;
const totalPages = Math.ceil(totalPosts / POSTS_PER_PAGE);
const posts = allPosts.slice(
  (currentPage - 1) * POSTS_PER_PAGE,
  currentPage * POSTS_PER_PAGE
);
---

<PageLayout title={BLOG.TITLE} description={BLOG.DESCRIPTION}>
  <TopLayout>
    <div
      class="text-xl md:text-2xl lg:text-3xl text-center animate page-heading"
    >
      {BLOG.TITLE}
    </div>
  </TopLayout>
  <BottomLayout>
    <div class="animate">
      <Blog client:load tags={tags} data={posts} />
      <Pagination currentPage={currentPage} totalPages={totalPages} />
    </div>
  </BottomLayout>
</PageLayout>
